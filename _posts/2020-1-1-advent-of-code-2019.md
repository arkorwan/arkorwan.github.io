---
layout: post
title: Advent of Code 2019 part 1 -- Intcode Computer Challenge 
tags: [programming]
---

ช่วงปลายปีที่แล้วมี[เพื่อน](https://twitter.com/PrachP)แนะนำให้รู้จักเว็บ [Advent of Code](https://adventofcode.com/2019)
ซึ่งก็เป็นเว็บแนว programming contest อีกเว็บหนึ่ง แต่มีความแตกต่าง คือตัวปัญหาถูกออกแบบมาในแนว puzzle ซะมากกว่า
คือไม่ได้ระบุ input/output มาแบบชัดเป๊ะแบบเว็บแนวนี้ทั่วๆ ไป แต่คนเล่นต้องพยายามแกะ requirement ที่แอบซ่อนไว้เอาเองด้วย
บางทีต้องทดลองรันโปรแกรมแบบครึ่งๆ กลางๆ เพื่อ probe ดูปัญหาว่าต้องรองรับเคสแปลกๆ แค่ไหน หรือบางข้อก็แก้โจทย์แบบ interactive ได้เลย
เป็นความท้าทายที่แตกต่างไปจากโจทย์ programming ปกติ

โจทย์มีทั้งหมด 25 วัน แต่ละวันเป็นปัญหาสองข้อ ข้อง่ายกับข้อยาก ต่อเนื่องกัน ยกเว้นวันสุดท้ายที่มีแค่ข้อเดียว รวมทั้งหมด 49 ข้อ
มีหลายข้อที่น่าสนใจ และหลายข้อที่เป็นโจทย์ต่อเนื่องกัน คือการสร้าง interpreter เพื่อรัน machine language ตัวหนึ่ง ซึ่งก็คือหัวข้อของเราในโพสนี้

## 'Intcode Computer'

ประมาณครึ่งหนึ่งของปัญหาทั้งหมดเป็นโจทย์ที่ให้เราสร้างโปรแกรมเพื่อรัน machine language ซึ่งทางเว็บตั้งชื่อไว้ว่า Intcode Computer[^1]
โจทย์ข้อแรกๆ (วันที่ 2, 5, 7, 9) จะเป็นการค่อยๆ เพื่ม spec ให้ภาษานี้ ข้อหลังๆ ของโจทย์ชุดนี้คือเราจะได้ input มาเป็นโปรแกรม Intcode เลย
แล้วเป็นหน้าที่ของเราที่ต้องเขียน interface โต้ตอบกับโปรแกรมที่ได้มา เหมือนได้กลับไปเรียนเขียนโค้ดกับพวก logic board โดยตรงอีกครั้ง ฮ่าๆ

ดู Spec ที่สมบูรณ์ของ Intcode ได้[ที่นี่](https://esolangs.org/wiki/Intcode)
ตรงนี้ผมขอสรุปย่อๆ ว่า Intcode มีความสามารถในการคำนวณ การเปรียบเทียบ flow control และมี relative addressing mode ซึ่งเอาไว้ทำ function call ได้
ทั้งหมดนี้ทำให้ Intcode เป็นภาษาที่ Turing complete นั่นคือสามารถทำการคำนวณใดๆ ที่ turing machine ทำได้ทั้งหมด

ผมสร้าง [class IntCode](code TBD) ตามที่ spec กำหนด และมี public methods ให้ใช้งานได้ดังนี้

* push(input: Integer) -- รับเลขหนึ่งตัว ใส่ลงไปที่ input queue
* push_all(inputs: Array[Integer]) -- ใส่เลขทั้งหมดใน input array ลงไปที่ input queue
* push_string(input: String) -- รับ string แปลงเป็น ascii code ใส่ลงไปที่ input queue
* run -- run โปรแกรมไปจนกระทั่ง halt, หรือต้องการ input เพิ่มเติม (คือเจอ input instruction แล้วไม่มี input อยู่ใน input queue)
return output ที่ได้ทั้งหมดเป็น array
* run_string -- เหมือน run แต่แปลง output ที่ได้เป็น string โดยถือว่าเลขที่มีค่าน้อยกว่า 128 คือ ascii code, เลขที่มากกว่านั้นคือตัวเลขธรรมดา
* clone -- ทำ deep copy ของ state ปัจจุบันของโปรแกรม ออกมาอีก instance หนึ่ง

ลองมาดูโจทย์ที่น่าสนใจกัน

## [Day 11: Space Police](https://adventofcode.com/2019/day/11)

ข้อนี้เป็นข้อแรกหลังจาก Intcode spec สมบูรณ์ 
เราจะได้ input มาเป็นโปรแกรม Intcode ซึ่งควบคุมหุ่นยนต์เพื่อทาสีบน square grid
โปรแกรมจะอ่านค่าสีบนพื้น (0 หรือ 1) แล้วจะ return สีที่ต้องทาทับลงไป กับทิศทางว่าจะให้หันซ้ายหรือขวา
จนกระทั่งเจอ halt instruction ก็หยุดทำงาน

Part 1 ถามว่า ถ้า input แรกเป็น 0 หุ่นจะทาสีลงไปกี่ช่อง

Part 2 ให้เปลี่ยน Input แรกเป็น 1 แล้วถามว่าเราเห็นตัวอักษรอะไรบนพื้น ผมก็แบบ งงๆ ว่าอักษรอะไรวะ แต่ก็ลองรันดู แล้วก็ได้ output หน้าตาเป็นแบบนี้

<div class='asciiart-container'><pre class='asciiart'>
 ■  ■   ■■  ■■  ■      ■■ ■■■■ ■■■■ ■  ■   
 ■  ■    ■ ■  ■ ■       ■    ■ ■    ■  ■   
 ■■■■    ■ ■  ■ ■       ■   ■  ■■■  ■■■■   
 ■  ■    ■ ■■■■ ■       ■  ■   ■    ■  ■   
 ■  ■ ■  ■ ■  ■ ■    ■  ■ ■    ■    ■  ■   
 ■  ■  ■■  ■  ■ ■■■■  ■■  ■■■■ ■    ■  ■   
</pre></div>

HJALJZFH เป็นตัวอักษรจริงด้วย!

ที่จริงโจทย์ข้อนี้ไม่ได้ tricky อะไร เราก็แค่เก็บพิกัดที่ทาสีไปแล้วไว้ใน hash อันหนึ่ง แล้วก็ simulate ไปจนจบ
แต่มันเริ่มทำให้ผม appreciate อยู่สองอย่าง

อย่างแรกคือ เฮ้ย ไอ้โปรแกรม Intcode (และคนตั้งโจทย์) นี่มันไม่ธรรมดานะเนี่ย
ทำงานได้ซับซ้อนเลยทีเดียว คือจริงๆ ถ้าเห็นเป็นโค้ดใน high-level langauge ที่เราใช้กันทั่วไปมันก็คงเฉยๆ
แต่พอ input มันเป็น low level เป็นเลขยาวๆ เราก็เลยรู้สึกประทับใจซะงั้น! ถึงแม้จริงๆ คนตั้งโจทย์เค้าก็ต้อง generate เลขนี่ด้วย compiler
จาก high-level ซักภาษานั่นแหละ

อีกอย่างก็คือ เราจะไม่ค่อยเจอโจทย์ลักษณะนี้ในที่อื่นๆ
คือถ้าเป็นโจทย์ที่ตรวจด้วย automate checker ตามปกติ เค้าก็จะต้องบอกมาอย่างละเอียดว่า ตัวอักษร 26 ตัวนี่มันหน้าตาเป็นยังไง
ซึ่งมันทำให้ขาด suspense ที่เราจะ print ได้อะไรออกมาก็ไม่รู้ อันนี้แหละคือเสน่ห์ของ Advent of Code

## [Day 13: Care Package](https://adventofcode.com/2019/day/13)

ข้อนี้เพิ่มความซับซ้อนของโปรแกรม Intcode ขึ้นไปอีกระดับ

Part 1 ไม่มี input อะไร โปรแกรมจะ output เลขออกมายาวๆ เป็นตำแหน่งของ game object เลขทุกๆ 3 ตัวจะบอกพิกัด x,y และบอกว่า
ตำแหน่งนั้นเป็น object อะไร กำแพง บล็อก ลูกบอล paddle หรือที่ว่าง โจทย์ถามง่ายๆ ว่ามี tile ที่เป็นบล็อกอยู่กี่อัน ก็แค่นับแล้วตอบ ง่ายๆ

แต่เราก็อยากรู้ว่าแล้วหน้าตาของเกมมันเป็นยังไง ก็เลยลองเขียนให้มัน print ออกมาดู

<div class='asciiart-container'><pre class='asciiart'>
########################################
#                                      #
#   ■  ■■■■ ■  ■  ■■■■     ■ ■ ■■■ ■   #
# ■■■ ■■  ■ ■■■■■■  ■■   ■■  ■■ ■■■■ ■ #
#  ■■ ■■■■ ■■■■ ■ ■■  ■■■ ■■■■■■  ■■   #
# ■■■■ ■■■■ ■■■■ ■■   ■     ■  ■■ ■  ■ #
# ■■■■■ ■ ■ ■ ■■■■ ■ ■■■ ■■■■■■ ■■■ ■  #
#  ■ ■■■■ ■  ■ ■■     ■■■  ■ ■■ ■■     #
#  ■  ■■■■■■■■■■■ ■  ■■■■■ ■■■  ■   ■  #
#  ■■ ■ ■■■     ■■■■■■■  ■  ■ ■■■■■ ■■ #
#  ■■■■ ■   ■■■ ■ ■      ■■ ■■  ■■■■■■ #
#   ■ ■  ■ ■ ■  ■ ■■  ■       ■■ ■■■■  #
#  ■■■ ■ ■ ■■■■■■■■■■ ■   ■ ■ ■ ■■■■■■ #
# ■ ■ ■■  ■■■■■■■ ■■   ■■ ■■  ■ ■■■■   #
#  ■  ■■       ■     ■ ■■■  ■ ■■ ■■■■■ #
# ■  ■  ■■■   ■■■■■■■ ■■■■■■  ■■ ■  ■■ #
# ■■  ■■■■ ■■■■    ■ ■■■ ■   ■ ■    ■  #
# ■■ ■■■ ■■■■■■■■■■■■■        ■ ■■■■ ■ #
#                                      #
#                 O                    #
#                                      #
#                                      #
#                   =                  #
#                                      #
</pre></div>

มันคือ เกมคลาสสิกในตำนาน [Breakout](https://en.wikipedia.org/wiki/Breakout_(video_game)) นั่นเอง

โจทย์ใน Part 2 บอกให้เราใส่ input เข้าไปที่โปรแกรม Intcode เพื่อขยับ paddle ทำลายบล็อกให้หมด
แล้วให้เอาคะแนนที่ได้มาเป็นคำตอบ ก็คือบอกให้เราเคลียร์เกมนี้ให้ได้นั่นละ

ผมก็เลยคิดว่า งั้นเราทำเป็น interactive mode เขียน TUI ด้วย curses (ซึ่งก็ไม่เคยเขียนมาก่อนเลย)
แล้วเล่นเองจริงๆ เลยดีกว่า ผลออกมาเป็น [code](TBD) นี้

ซึ่งไม่เวิร์คครับผม แป่ว

สาเหตุก็คือ นี่ไม่ใช่ action game เหมือนอย่าง breakout จริงๆ แต่เป็น turn-based ต่างหาก!
คือทุกครั้งที่เราใส่ input เข้าไป จะขยับ paddle ได้ 1 ช่อง พร้อมๆ กันนั้น ลูกบอลก็จะขยับไป 1 ช่องเช่นกัน
คือเราไม่สามารถทำความเร็วแซงลูกบอลได้เลย ดังนั้นจึงต้องเลื่อน paddle ให้ track ตำแหน่งในแกน x ของลูกบอลไว้ตลอด
ขยับผิดข้างเมื่อไหร่ เรียกได้ว่าแทบจะแพ้ในทันที

ซึ่งงานแบบนี้มันเหมาะให้เครื่องทำมากกว่ามานั่งจิ้มเองแน่ๆ สุดท้ายก็เลยต้องเขียนเป็น [code](TBD) อยู่ดี
แต่ไหนๆ ก็อุตส่าห์ทำ interface ไว้แล้ว ผมก็เลยให้เก็บ interface นี้ไว้เป็น display แล้วมานั่งดูคอมเล่นแทน ฮ่าๆ

(gif TBD)

#### Notes

(โค้ดที่ใช้แก้โจทย์ผมเขียนด้วย ruby ล้วนๆ แต่ต้องออกตัวไว้ก่อนว่าหน้าตาอาจจะดูแปลกๆ unconventional หน่อย
เพราะผมใช้ ruby เพื่อทำโจทย์พวกนี้อย่างเดียวเลย ไม่เคยใช้ทำ project จริงๆ จังๆ ซักที เขียนเองอ่านเองคนเดียวว่างั้นเถอะ)

[^1]: ผมลอง search ดู ภาษาที่ใช้ชื่อ Intcode นั้นมีอยู่จริงๆ [link](http://foldoc.org/INTCODE) แต่เป็นคนละภาษากับที่ใช้ในโจทย์ของเรา